/******************************************************************************
    Copyright 2012 Martin Karsten

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
******************************************************************************/
# GCC: first argument in %rdi, second argument in %rsi
# see http://en.wikipedia.org/wiki/X86_calling_conventions

# save callee-owned registers, caller-owned automatically saved by handler subroutines
# see http://x86-64.org/documentation/abi.pdf, Sec 3.2.1

.macro ISR_TOP irq_num
.globl   isr_wrapper_\irq_num
.align   8
isr_wrapper_\irq_num:
.endm

.macro ISR_BOTTOM irq_num
  iretq
.endm

.macro ISR_PUSH
	push %rbp
	push %rax
	push %rcx
	push %rdx
	push %rsi
	push %rdi
	push %r8
	push %r9
	push %r10
	push %r11
.endm

.macro ISR_POP
	pop %r11
	pop %r10
	pop %r9
	pop %r8
	pop %rdi
	pop %rsi
	pop %rdx
	pop %rcx
	pop %rax
	pop %rbp
.endm

.macro ISR_DIRECT irq_num
ISR_TOP \irq_num
	ISR_PUSH
	call isr_handler_\irq_num
	ISR_POP
ISR_BOTTOM \irq_num
.endm

.macro ISR_DIRECT_ERRCODE_ADDR irq_num
ISR_TOP \irq_num
	ISR_PUSH
	mov  80(%rsp), %rdi
	mov  88(%rsp), %rsi
	call isr_handler_\irq_num
	ISR_POP
	add $8, %rsp
ISR_BOTTOM \irq_num
.endm

.macro ISR_GENERIC irq_num
ISR_TOP \irq_num
	ISR_PUSH
	mov  $\irq_num, %rdi
	call isr_handler_gen
	ISR_POP
ISR_BOTTOM \irq_num
.endm

.macro ISR_GENERIC_ERRCODE irq_num
ISR_TOP \irq_num
	ISR_PUSH
	mov  $\irq_num, %rdi
	mov  80(%rsp), %rsi
	call isr_handler_gen_err
	ISR_POP
	add $8, %rsp
ISR_BOTTOM \irq_num
.endm

ISR_GENERIC 0x00
ISR_GENERIC 0x01
ISR_GENERIC 0x02
ISR_GENERIC 0x03
ISR_GENERIC 0x04
ISR_GENERIC 0x05
ISR_GENERIC 0x06
ISR_GENERIC 0x07
ISR_DIRECT 0x08
ISR_GENERIC 0x09
ISR_GENERIC_ERRCODE 0x0a
ISR_GENERIC_ERRCODE 0x0b
ISR_DIRECT_ERRCODE_ADDR 0x0c
ISR_DIRECT_ERRCODE_ADDR 0x0d
ISR_DIRECT_ERRCODE_ADDR 0x0e
ISR_GENERIC 0x0f
ISR_GENERIC 0x10
ISR_GENERIC 0x11
ISR_GENERIC 0x12
ISR_GENERIC 0x13
ISR_GENERIC 0x14
ISR_GENERIC 0x15
ISR_GENERIC 0x16
ISR_GENERIC 0x17
ISR_GENERIC 0x18
ISR_GENERIC 0x19
ISR_GENERIC 0x1a
ISR_GENERIC 0x1b
ISR_GENERIC 0x1c
ISR_GENERIC 0x1d
ISR_GENERIC 0x1e
ISR_GENERIC 0x1f
ISR_DIRECT 0x20
ISR_DIRECT 0x21
ISR_GENERIC 0x22
ISR_GENERIC 0x23
ISR_GENERIC 0x24
ISR_GENERIC 0x25
ISR_GENERIC 0x26
ISR_GENERIC 0x27
ISR_DIRECT 0x28
ISR_DIRECT 0x29
ISR_GENERIC 0x2a
ISR_GENERIC 0x2b
ISR_GENERIC 0x2c
ISR_GENERIC 0x2d
ISR_GENERIC 0x2e
ISR_GENERIC 0x2f
ISR_GENERIC 0x30
ISR_GENERIC 0x31
ISR_GENERIC 0x32
ISR_GENERIC 0x33
ISR_GENERIC 0x34
ISR_GENERIC 0x35
ISR_GENERIC 0x36
ISR_GENERIC 0x37
ISR_GENERIC 0x38
ISR_GENERIC 0x39
ISR_GENERIC 0x3a
ISR_GENERIC 0x3b
ISR_GENERIC 0x3c
ISR_GENERIC 0x3d
ISR_GENERIC 0x3e
ISR_GENERIC 0x3f
ISR_DIRECT 0x40
ISR_DIRECT 0x41
ISR_GENERIC 0x42
ISR_GENERIC 0x43
ISR_GENERIC 0x44
ISR_GENERIC 0x45
ISR_GENERIC 0x46
ISR_GENERIC 0x47
ISR_GENERIC 0x48
ISR_GENERIC 0x49
ISR_GENERIC 0x4a
ISR_GENERIC 0x4b
ISR_GENERIC 0x4c
ISR_GENERIC 0x4d
ISR_GENERIC 0x4e
ISR_GENERIC 0x4f
ISR_GENERIC 0x50
ISR_GENERIC 0x51
ISR_GENERIC 0x52
ISR_GENERIC 0x53
ISR_GENERIC 0x54
ISR_GENERIC 0x55
ISR_GENERIC 0x56
ISR_GENERIC 0x57
ISR_GENERIC 0x58
ISR_GENERIC 0x59
ISR_GENERIC 0x5a
ISR_GENERIC 0x5b
ISR_GENERIC 0x5c
ISR_GENERIC 0x5d
ISR_GENERIC 0x5e
ISR_GENERIC 0x5f
ISR_GENERIC 0x60
ISR_GENERIC 0x61
ISR_GENERIC 0x62
ISR_GENERIC 0x63
ISR_GENERIC 0x64
ISR_GENERIC 0x65
ISR_GENERIC 0x66
ISR_GENERIC 0x67
ISR_GENERIC 0x68
ISR_GENERIC 0x69
ISR_GENERIC 0x6a
ISR_GENERIC 0x6b
ISR_GENERIC 0x6c
ISR_GENERIC 0x6d
ISR_GENERIC 0x6e
ISR_GENERIC 0x6f
ISR_GENERIC 0x70
ISR_GENERIC 0x71
ISR_GENERIC 0x72
ISR_GENERIC 0x73
ISR_GENERIC 0x74
ISR_GENERIC 0x75
ISR_GENERIC 0x76
ISR_GENERIC 0x77
ISR_GENERIC 0x78
ISR_GENERIC 0x79
ISR_GENERIC 0x7a
ISR_GENERIC 0x7b
ISR_GENERIC 0x7c
ISR_GENERIC 0x7d
ISR_GENERIC 0x7e
ISR_GENERIC 0x7f
ISR_GENERIC 0x80
ISR_GENERIC 0x81
ISR_GENERIC 0x82
ISR_GENERIC 0x83
ISR_GENERIC 0x84
ISR_GENERIC 0x85
ISR_GENERIC 0x86
ISR_GENERIC 0x87
ISR_GENERIC 0x88
ISR_GENERIC 0x89
ISR_GENERIC 0x8a
ISR_GENERIC 0x8b
ISR_GENERIC 0x8c
ISR_GENERIC 0x8d
ISR_GENERIC 0x8e
ISR_GENERIC 0x8f
ISR_GENERIC 0x90
ISR_GENERIC 0x91
ISR_GENERIC 0x92
ISR_GENERIC 0x93
ISR_GENERIC 0x94
ISR_GENERIC 0x95
ISR_GENERIC 0x96
ISR_GENERIC 0x97
ISR_GENERIC 0x98
ISR_GENERIC 0x99
ISR_GENERIC 0x9a
ISR_GENERIC 0x9b
ISR_GENERIC 0x9c
ISR_GENERIC 0x9d
ISR_GENERIC 0x9e
ISR_GENERIC 0x9f
ISR_GENERIC 0xa0
ISR_GENERIC 0xa1
ISR_GENERIC 0xa2
ISR_GENERIC 0xa3
ISR_GENERIC 0xa4
ISR_GENERIC 0xa5
ISR_GENERIC 0xa6
ISR_GENERIC 0xa7
ISR_GENERIC 0xa8
ISR_GENERIC 0xa9
ISR_GENERIC 0xaa
ISR_GENERIC 0xab
ISR_GENERIC 0xac
ISR_GENERIC 0xad
ISR_GENERIC 0xae
ISR_GENERIC 0xaf
ISR_GENERIC 0xb0
ISR_GENERIC 0xb1
ISR_GENERIC 0xb2
ISR_GENERIC 0xb3
ISR_GENERIC 0xb4
ISR_GENERIC 0xb5
ISR_GENERIC 0xb6
ISR_GENERIC 0xb7
ISR_GENERIC 0xb8
ISR_GENERIC 0xb9
ISR_GENERIC 0xba
ISR_GENERIC 0xbb
ISR_GENERIC 0xbc
ISR_GENERIC 0xbd
ISR_GENERIC 0xbe
ISR_GENERIC 0xbf
ISR_GENERIC 0xc0
ISR_GENERIC 0xc1
ISR_GENERIC 0xc2
ISR_GENERIC 0xc3
ISR_GENERIC 0xc4
ISR_GENERIC 0xc5
ISR_GENERIC 0xc6
ISR_GENERIC 0xc7
ISR_GENERIC 0xc8
ISR_GENERIC 0xc9
ISR_GENERIC 0xca
ISR_GENERIC 0xcb
ISR_GENERIC 0xcc
ISR_GENERIC 0xcd
ISR_GENERIC 0xce
ISR_GENERIC 0xcf
ISR_GENERIC 0xd0
ISR_GENERIC 0xd1
ISR_GENERIC 0xd2
ISR_GENERIC 0xd3
ISR_GENERIC 0xd4
ISR_GENERIC 0xd5
ISR_GENERIC 0xd6
ISR_GENERIC 0xd7
ISR_GENERIC 0xd8
ISR_GENERIC 0xd9
ISR_GENERIC 0xda
ISR_GENERIC 0xdb
ISR_GENERIC 0xdc
ISR_GENERIC 0xdd
ISR_GENERIC 0xde
ISR_GENERIC 0xdf
ISR_GENERIC 0xe0
ISR_GENERIC 0xe1
ISR_GENERIC 0xe2
ISR_GENERIC 0xe3
ISR_GENERIC 0xe4
ISR_GENERIC 0xe5
ISR_GENERIC 0xe6
ISR_GENERIC 0xe7
ISR_GENERIC 0xe8
ISR_GENERIC 0xe9
ISR_GENERIC 0xea
ISR_GENERIC 0xeb
ISR_GENERIC 0xec
ISR_GENERIC 0xed
ISR_GENERIC 0xee
ISR_GENERIC 0xef
ISR_GENERIC 0xf0
ISR_GENERIC 0xf1
ISR_GENERIC 0xf2
ISR_GENERIC 0xf3
ISR_GENERIC 0xf4
ISR_GENERIC 0xf5
ISR_GENERIC 0xf6
ISR_GENERIC 0xf7
ISR_DIRECT 0xf8
ISR_GENERIC 0xf9
ISR_GENERIC 0xfa
ISR_GENERIC 0xfb
ISR_GENERIC 0xfc
ISR_GENERIC 0xfd
ISR_GENERIC 0xfe
ISR_DIRECT 0xff
